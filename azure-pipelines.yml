trigger:
  branches:
    include:
      - main

pool:
  name: 'default'

variables:
  NODE_VERSION: '18'
  PACKAGE_PATH: '.'
  ORGANIZATION: 'nubeeratechnologies'
  FEED: 'myartifact'

steps:
# Step 1 — Use Node.js
- task: UseNode@1
  inputs:
    versionSpec: '18.20.8'
  displayName: 'Use Node.js 18'

# Step 2 — Authenticate npm to Azure Artifacts
- task: npmAuthenticate@0
  displayName: 'Authenticate npm to Azure Artifacts'
  inputs:
    workingFile: '.npmrc'

# Step 3 — Install dependencies & build
- script: |
    cd $(PACKAGE_PATH)
    npm ci
    npm run build
  displayName: 'Install & build package'

# Step 4 — Run tests (optional)
- script: |
    cd $(PACKAGE_PATH)
    npm test || true
  displayName: 'Run tests (optional)'

- script: |
    npm version patch --no-git-tag-version
  displayName: "Auto bump version"
  
# Step 5 — Publish to Azure Artifacts
- script: |
    cd $(PACKAGE_PATH)
    npm publish
  displayName: 'Publish npm package to Azure Artifacts'
  env:
    NODE_EXTRA_CA_CERTS: $(Agent.TrustedCertPath)
